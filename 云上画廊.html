<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç«¯ç”»å»Šç³»ç»Ÿ</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        :root { --primary: #4f46e5; --bg: #f3f4f6; --white: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        
        header { background: var(--white); padding: 1rem 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: var(--white); padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        
        input, textarea { width: 100%; padding: 0.8rem; margin: 0.5rem 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;}
        button { background: var(--primary); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 4px; cursor: pointer; }
        button:hover { opacity: 0.9; }
        button.danger { background: #ef4444; margin-top: 10px; width: 100%;}
        
        .hidden { display: none !important; }

        /* --- ç”»å»Šæ ·å¼ --- */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .art-item { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .art-item:hover { transform: translateY(-3px); }
        
        /* å›¾ç‰‡æ ·å¼ï¼šå¢åŠ  cursor: pointer æš—ç¤ºå¯ç‚¹å‡» */
        .art-img { width: 100%; height: 200px; object-fit: cover; cursor: zoom-in; }
        
        .art-info { padding: 1rem; }
        .art-title { margin: 0 0 0.5rem 0; font-size: 1.1rem; }
        .art-desc { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }

        /* --- å›¾ç‰‡æ”¾å¤§é®ç½©å±‚ (Lightbox) --- */
        #lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); /* é»‘è‰²åŠé€æ˜èƒŒæ™¯ */
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; cursor: zoom-out;
        }
        #lightbox img {
            max-width: 90%; max-height: 90%;
            border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <!-- å›¾ç‰‡æ”¾å¤§é®ç½©å±‚ (é»˜è®¤éšè—) -->
    <div id="lightbox" class="hidden" onclick="closeLightbox()">
        <img id="lightbox-img" src="" alt="å¤§å›¾">
    </div>

    <header>
        <h1 style="color: var(--primary); margin:0;">ğŸ¨ äº‘ç«¯ç”»å»Š</h1>
        <div>
            <span id="user-display" style="margin-right: 15px; font-weight: bold;"></span>
            <input type="text" id="search-who" placeholder="æœç”¨æˆ·å" style="width: 150px; display:inline-block;">
            <button onclick="viewGallery()">ğŸ”</button>
            <button onclick="logout()" id="logout-btn" class="hidden" style="background:#999; margin-left:10px;">é€€å‡º</button>
        </div>
    </header>

    <div class="container">
        <!-- ç™»å½•/æ³¨å†Œ -->
        <div id="auth-box" class="card">
            <h2 id="auth-title">ç™»å½•</h2>
            <input type="text" id="username" placeholder="ç”¨æˆ·å">
            <input type="password" id="password" placeholder="å¯†ç ">
            <button onclick="handleAuth()" id="auth-btn">ç™»å½•</button>
            <p><a href="#" onclick="toggleMode()">åˆ‡æ¢ ç™»å½•/æ³¨å†Œ</a></p>
        </div>

        <!-- ä¸Šä¼  (ç™»å½•åæ˜¾ç¤º) -->
        <div id="upload-box" class="card hidden">
            <h3>ğŸ“¤ ä¸Šä¼ æ–°ç”»ä½œ</h3>
            <input type="text" id="u-title" placeholder="ä½œå“æ ‡é¢˜ (å”¯ä¸€)">
            <input type="text" id="u-img" placeholder="å›¾ç‰‡é“¾æ¥ (http://...)">
            <input type="text" id="u-content" placeholder="ä»‹ç»ä¸€ä¸‹...">
            <button onclick="uploadWork()">å‘å¸ƒ</button>
        </div>

        <!-- å±•ç¤ºåŒº -->
        <h2 id="gallery-name">å…¬å…±å±•å…</h2>
        <div id="gallery-grid" class="gallery-grid"></div>
    </div>

    <script>
        const API = "";
        let isLogin = true;
        let myName = "";

        // åˆå§‹åŒ–
        window.onload = () => {
            const token = localStorage.getItem("token");
            if (token) {
                myName = localStorage.getItem("username");
                showLoginState();
            }
        };

        // --- 1. ç‚¹å‡»æ”¾å¤§åŠŸèƒ½ ---
        function openLightbox(src) {
            const box = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = src;
            box.classList.remove('hidden');
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.add('hidden');
        }

        // --- 2. æ ¸å¿ƒä¸šåŠ¡ ---
        async function handleAuth() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const url = isLogin ? "/login" : "/register";

            try {
                const res = await fetch(API + url, {
                    method: "POST",
                    body: JSON.stringify({username: u, password: p})
                });
                const data = await res.json();
                
                if(res.status === 200) {
                    if(isLogin) {
                        localStorage.setItem("token", data.token);
                        localStorage.setItem("username", u);
                        myName = u;
                        showLoginState();
                    } else {
                        alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
                        toggleMode();
                    }
                } else {
                    alert(data.error);
                }
            } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
        }

        async function uploadWork() {
            const body = {
                title: document.getElementById('u-title').value,
                image: document.getElementById('u-img').value,
                content: document.getElementById('u-content').value
            };
            if(!body.title || !body.image) return alert("å†™å…¨ç‚¹ï¼");

            const res = await fetch(API + "/my/upload", {
                method: "POST",
                headers: { "Authorization": "Bearer " + localStorage.getItem("token") },
                body: JSON.stringify(body)
            });
            if(res.ok) {
                alert("ä¸Šä¼ æˆåŠŸ");
                viewGallery(myName);
            } else {
                alert("ä¸Šä¼ å¤±è´¥");
            }
        }

        // --- ä¿®å¤åçš„åˆ é™¤åŠŸèƒ½ ---
        async function deleteWork(title) {
            if(!confirm("ç¡®å®šè¦åˆ æ‰ã€Š" + title + "ã€‹å—ï¼Ÿ")) return;

            try {
                // è¿™é‡Œçš„ URL å¿…é¡»å’Œ main.go é‡Œçš„è·¯ç”±ä¸€è‡´ (/my/delect)
                const res = await fetch(API + "/my/delect", {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + localStorage.getItem("token") },
                    // è¿™é‡Œä¼  JSONï¼Œå¯¹åº” api.go é‡Œçš„ ShouldBindJSON
                    body: JSON.stringify({ title: title }) 
                });

                const data = await res.json();
                if(res.status === 200) {
                    alert("å·²åˆ é™¤");
                    viewGallery(myName); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert(data.error || "åˆ é™¤å¤±è´¥");
                }
            } catch(e) {
                console.error(e);
                alert("ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦æŠ¥é”™");
            }
        }

        async function viewGallery(who) {
            const target = who || document.getElementById('search-who').value;
            if(!target) return;

            const res = await fetch(API + "/gallery/" + target);
            const data = await res.json();
            
            document.getElementById('gallery-name').innerText = target + " çš„å±•å…";
            const grid = document.getElementById('gallery-grid');
            grid.innerHTML = "";

            if(data.works) {
                data.works.forEach(w => {
                    const isMine = (myName === target);
                    // æ³¨æ„ img æ ‡ç­¾é‡Œçš„ onclick="openLightbox(...)"
                    const html = `
                        <div class="art-item">
                            <img src="${w.image}" class="art-img" onclick="openLightbox(this.src)" title="ç‚¹å‡»æ”¾å¤§">
                            <div class="art-info">
                                <div class="art-title">${w.title}</div>
                                <div class="art-desc">${w.content}</div>
                                ${isMine ? `<button class="danger" onclick="deleteWork('${w.title}')">åˆ é™¤</button>` : ""}
                            </div>
                        </div>
                    `;
                    grid.innerHTML += html;
                });
            } else {
                grid.innerHTML = "<p>è¿˜æ²¡ä½œå“å‘¢</p>";
            }
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function toggleMode() {
            isLogin = !isLogin;
            document.getElementById('auth-title').innerText = isLogin ? "ç™»å½•" : "æ³¨å†Œ";
            document.getElementById('auth-btn').innerText = isLogin ? "ç™»å½•" : "æ³¨å†Œ";
        }
        function showLoginState() {
            document.getElementById('auth-box').classList.add('hidden');
            document.getElementById('upload-box').classList.remove('hidden');
            document.getElementById('logout-btn').classList.remove('hidden');
            document.getElementById('user-display').innerText = "Hi, " + myName;
            viewGallery(myName);
        }
        function logout() {
            localStorage.clear();
            location.reload();
        }
    </script>
</body>
</html>